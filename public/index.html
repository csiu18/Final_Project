<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" href="bus_logo.png">

<title>Tufts Rides</title>

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">
<link rel="stylesheet" href="stylesheet.css">
<link rel="stylesheet" href="index.css">

<script src="https://code.jquery.com/jquery-3.3.1.min.js" 
        integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT" 
        crossorigin="anonymous">
</script>
<script type="text/javascript" src="menu.js"></script>

<script type="text/javascript">

    function getResults(){
        alert("hi");
        // based on search results, it will display wanted stop by calling a
        // request/pulling from database
    }
    
    // y height will change depending on how many fav stops there are
    function displayFavs() {
        var x = document.getElementById("favstop");
        var y = document.getElementById("background");
        if (x.style.display === "none") {
            x.style.display = "block";
            y.style.height = "1700px";
        } else {
            x.style.display = "none";
            y.style.height = "1500px";
        }   
    }

</script>

  <!----- Map ----->
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v1.9.1/mapbox-gl.css' rel='stylesheet' />
  
  <!-- Direction -->
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js"></script>
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css" type="text/css" />

  <!-- Distance -->
  <script src="https://npmcdn.com/@turf/turf@5.1.6/turf.min.js"></script>

  <!-- LeafLet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>

</head>

<body onload="getLocation()">
<style>
    .marker {
        display: block;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        padding: 0;
    }

    .mapboxgl-popup {
        max-width: 400px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
    }
</style>

<!------------- HEADER & NAV MENU --------------->
<div class="header">
    <a href="index.html"><img class="logo" src="logo.png"></a>
    <i id="menu-ham" class="fa fa-bars"></i>
</div>

<div class="menu">
    <div class="close-menu">
        <i id="menu-ham" class="fa fa-bars" style="color: black"></i>       
    </div>
    <ul>
        <li><span class="menu-icon"><i class="fas fa-home"></i></span><a href="index.html">Home</a></li>
        <li><span class="menu-icon"><i class="fas fa-info"></i></span><a href="about.html">About</a></li>
        <li><span class="menu-icon"><i class="fas fa-calendar"></i></span><a href=#>Schedule</a></li>
        <li style="border-bottom: 2px solid #ededed;"><span class="menu-icon"><i class="fas fa-id-card"></i></span><a href="contact.html">Contact</a></li>
    </ul>
</div>

<!-------------- MAP ------------------>

<div id='map' style='height: 500px;'></div>

<script>
// Access Token
mapboxgl.accessToken = 'pk.eyJ1IjoiYW5rb2FuanUiLCJhIjoiY2s5NmQwYXczMHVkdDNob201MmljZnk3OSJ9.X6W7DiJbZEsLh8RRO10T4w';

//-------------------- Set up the Map -----------------------//

// Initialize, and set position and orientation
var map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v9',
    center: [-71.12213,42.40411], // starting position 
      zoom: 15,// starting zoom
    bearing: 80 // pitch in degrees
});

// Add Search Box 
var directions = new MapboxDirections({
    accessToken: mapboxgl.accessToken
  });
  map.addControl(directions, 'top-left');

// Add the stops labels
var CC_P_Row = new mapboxgl.Marker()
  .setLngLat([-71.119681, 42.405880]) 
  .addTo(map);

var Davis = new mapboxgl.Marker()
  .setLngLat([-71.122819, 42.396884]) 
  .addTo(map);

var TAB = new mapboxgl.Marker()
  .setLngLat([-71.125800, 42.400951]) 
  .addTo(map);


var CC_Talbot = new mapboxgl.Marker()
  .setLngLat([-71.120386, 42.405274]) 
  .addTo(map); 


var Carm = new mapboxgl.Marker()
  .setLngLat([-71.122377, 42.409699]) 
  .addTo(map); 

var Olin = new mapboxgl.Marker()
  .setLngLat([-71.120896, 42.408284]) 
  .addTo(map); 


// Add stop names as mouse hover pop ups

  map.on('load', function() {
  map.addSource('places', {
  'type': 'geojson',
  'data': {
  'type': 'FeatureCollection',
  'features': [
  {
  'type': 'Feature',
    'properties': {
    'description':                       
      '<strong>Mayer Campus Center P-Row</strong>',
    'icon': 'theatre'
    },
    'geometry': {
    'type': 'Point',
    'coordinates': [-71.119681, 42.405880] //CC_P_Row
    }
  },

  {
    'type': 'Feature',
    'properties': {
    'description':                        
      '<strong>Davis Square</strong>',
    'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.122819, 42.396884] // Davis Square
      }
  },

  {
    'type': 'Feature',
    'properties': {
    'description':                       
      '<strong>Tufts Administration Building</strong>',
    'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.125800, 42.400951] // TAB
      }
  },

  {
      'type': 'Feature',
      'properties': {
      'description':                        
        '<strong>Mayer Campus Ctr - Talbot</strong>',
      'icon': 'theatre'
    },
        'geometry': {
        'type': 'Point',
        'coordinates': [-71.120386, 42.405274] // CC_Talbot 
      }
    },

  {
      'type': 'Feature',
      'properties': {
      'description':                        
        '<strong>Carmichael Hall</strong>',
      'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.122377, 42.409699] // Carmichael Hall
      }
    },

    {
      'type': 'Feature',
      'properties': {
      'description':                       
        '<strong>Olin Center</strong>',
      'icon': 'theatre'
    },
      'geometry': {
      'type': 'Point',
      'coordinates': [-71.120896, 42.408284] // Olin Center
      }
    }
  ]
  }
  });

  // Add a layer showing the places.
  map.addLayer({
  'id': 'places',
  'type': 'symbol',
  'source': 'places',
  'layout': {
  'icon-image': '{icon}-15',
  'icon-allow-overlap': true
  }
  });
  
  // Create a popup, but don't add it to the map yet.
  var popup = new mapboxgl.Popup({
    closeButton: false,
    closeOnClick: false
  });
  
  map.on('mouseenter', 'places', function(e) {
  // Change the cursor style as a UI indicator.
  map.getCanvas().style.cursor = 'pointer';
  
  var coordinates = e.features[0].geometry.coordinates.slice();
  var description = e.features[0].properties.description;
  
  // Ensure that if the map is zoomed out such that multiple
  // copies of the feature are visible, the popup appears
  // over the copy being pointed to.
  while (Math.abs(e.lngLat.lng - coordinates[0]) > 180) {
  coordinates[0] += e.lngLat.lng > coordinates[0] ? 360 : -360;
  }
  
  // Populate the popup and set its coordinates
  // based on the feature found.
  popup
      .setLngLat(coordinates)
      .setHTML(description)
      .addTo(map);
  });
  
  map.on('mouseleave', 'places', function() {
      map.getCanvas().style.cursor = '';
      popup.remove();
      });
  });


//------------------------- Get User Location ----------------------//

var validPos = false;

function getLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(storeLocation);
        validPos = true;
    } else { 
        x.innerHTML = "Geolocation is not supported by this browser.";
    }
}

var myLat = 0.0;
var myLong = 0.0;

function storeLocation(position) {
    myLat = position.coords.latitude;
    myLong = position.coords.longitude;
    findshortest(myLong, myLat);
}

// Click the button on map and display user's location
map.addControl(
    new mapboxgl.GeolocateControl({
      positionOptions: {
      enableHighAccuracy: true
    },
      trackUserLocation: true
    })
)

//------------------------- Find closest station ----------------------//

// store an json object with stnames, coords, and address, temporary for now
// retrive from database later
var stations = [
  {
    "stname" : "CC_P_Row",
    "coords" : [-71.119681, 42.405880],
    "address" : "40 Professors Row, Medford, Massachusetts 02155, United States"
  },
  {
    "stname" : "Davis",
    "coords" : [-71.122819, 42.396884],
    "address" : "Boston Burger Company, 37 Davis Sq, Somerville, Massachusetts 02144, United States"
  },
  {
    "stname" : "TAB",
    "coords" : [-71.125800, 42.400951],
    "address" : "155 Holland Street, Somerville, Massachusetts 02144, United States"
  },
   {
    "stname" : "CC_Talbot", 
    "coords" : [-71.120386, 42.405274],
    "address": "Jumbo Express, Talbot Ave, Medford, Massachusetts 02155, United States"
  },
   {
    "stname" : "Carm",
    "coords" : [-71.122377, 42.409699],
    "address" : "Carmichael Dining Hall, 200 Packard Ave, Medford, Massachusetts 02155, United States"
  },
   {
    "stname" : "Olin",
    "coords" : [-71.120896, 42.408284],
    "address" : "Olin Center, 180 Packard Ave, Medford, Massachusetts 02155, United States"
  }
];


function findshortest(longval, latval) 
{
  // change after getting database 
  var from = turf.point([longval, latval]);
  var options = {units: 'meters'};

  var indexShortest = 0;
  var shortestname = "";
  var distance = 0;
  var comparedist = 0;

  // compare all the distances and find the shortest
  for (i = 0; i < stations.length; i++) {
      var to = turf.point(stations[i].coords);
      distance = turf.distance(from, to, options);
      if ( comparedist == 0 ){
        comparedist = distance;
      } else if ( distance < comparedist ) {
        comparedist = distance;
        shortestname = stations[i].stname;
        indexShortest = i;
        // Debugging statements
          console.log("shortestdist is  " + comparedist + "\n");
          console.log("shortest to from is " + shortestname + "\n");
      }
  }

   // Debugging statements
    console.log(longval+ " and " + latval);
    console.log("index is " + indexShortest);
    console.log("this is lat" + stations[indexShortest].coords[1]);
    console.log("this is long" + stations[indexShortest].coords[0]);
  
  // Set map origin and destination
  directions.setOrigin(longval+ "," + latval);
  directions.setDestination(stations[indexShortest].address);
}

</script>

<!-------------- END OFMAP ------------------>


<div id="background" class="background">
    <div class="sbar">
        <input type="text" placeholder="Search for a stop...">
        <i id="search" class="fa fa-search" onclick="getResults()"></i>
    </div>

    <div class="favorites">
        <i id="down" class="fas fa-sort-down" onclick="displayFavs()"></i><h3>FAVORITES</h3>
    </div>

    <div id="favstop" class="stop">
        <h3>DAVIS SQUARE<div class="time2"></div><div class="time1"></div></h3>
        <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Campus</div>
    </div>

    <div class="allstops"><h3>ALL STOPS</h3></div>

    <div class="results">
        <div class="stop">
            <h3>CAMPUS CENTER FRONT<i id="star" class="far fa-star"></i><div id="time2" class="time1b"></div><div id="time1" class="time1a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Davis Square</div>
        </div>
        <div class="stop">
            <h3>DAVIS SQUARE<i id="star" class="far fa-star"></i><div id="time2" class="time2b"></div><div id="time1" class="time2a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Campus</div>
        </div>
        <div class="stop">
            <h3>CAMPUS CENTER BACK<i id="star" class="far fa-star"></i><div id="time2" class="time3b"></div><div id="time1" class="time3a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Davis Square</div>
        </div>
        <div class="stop">
            <h3>CARMICHAEL HALL<i id="star" class="far fa-star"></i><div id="time2" class="time4b"></div><div id="time1" class="time4a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Davis Square</div>
        </div>
        <div class="stop">
            <h3>OLIN HALL<i id="star" class="far fa-star"></i><div id="time2" class="time5b"></div><div id="time1" class="time5a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Davis Square</div>
        </div>
        <div class="stop">
            <h3>AIDEKMAN<i id="star" class="far fa-star"></i><div id="time2" class="time6b"></div><div id="time1" class="time6a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>SMFA</div>
        </div>
        <div class="stop">
            <h3>SMFA<i id="star" class="far fa-star"></i><div id="time2" class="time7b"></div><div id="time1" class="time7a"></div></h3>
            <div class="dest"><i id="arrow" class="fa fa-arrow-right"></i>Aidekman</div>
        </div>
    </div>
</div>

<!-- Make email open up a window when clicked on -->
<!-------------------- FOOTER ---------------------->
<div class="footer">
    <h1>TUFTS RIDES</h1>
    <p><a href="about.html" target="_blank">About</a> | <a href=# target="_blank">Schedule</a>| <a href="contact.html" target="_blank">Contact</a> | info@tuftsrides.com<p> 
    <p>COPYRIGHT TUFTS RIDES 2020, ALL RIGHTS RESERVED</p>
</div>

<script type="text/javascript" src="client.js"></script>

</body>
</html>